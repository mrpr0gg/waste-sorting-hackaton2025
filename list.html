<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Выбор предмета</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f6d95c;
            font-family: "Inter", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            margin-top: 40px;
            font-size: 42px;
            font-weight: 800;
            text-align: center;
        }

        .search-box {
            margin-top: 25px;
            width: 90%;
            max-width: 550px;
        }

        .search {
            width: 100%;
            padding: 14px 18px;
            font-size: 20px;
            border-radius: 14px;
            border: none;
            background: rgba(255,255,255,0.75);
            outline: none;
        }

        .grid-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .grid {
            margin-top: 35px;
            width: 95%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            padding: 0 20px 50px 20px;
        }

        .item {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(12px);
            border-radius: 22px;
            padding: 18px;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.25s ease;
        }

        .item:hover {
            transform: scale(1.06);
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        }

        .loading-video {
            position: fixed;
            inset: 0; /* top:0; right:0; bottom:0; left:0 */
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 9999;
            display: none;           /* по умолчанию скрыто */
            background: black;
        }

        /* мягкое появление / исчезновение, по желанию */
        .loading-video.fade-in {
            animation: loadingFadeIn 0.4s ease forwards;
        }
        .loading-video.fade-out {
            animation: loadingFadeOut 0.4s ease forwards;
        }

        @keyframes loadingFadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        @keyframes loadingFadeOut {
            from { opacity: 1; }
            to   { opacity: 0; }
        }

    </style>
</head>

<body>

<h1>Выберите предмет</h1>

<div class="search-box">
    <input class="search" id="search" placeholder="Поиск...">
</div>

<div class="grid-wrapper">
    <div class="grid" id="grid"></div>
</div>

<script>
const items = [
    // Пластик
    "Пластиковая бутылка", "ПЭТ бутылка", "Пластиковый контейнер",
    "Пластиковый стакан", "Пластиковая ложка", "Пластиковая вилка",
    "Пластиковый нож", "Одноразовая тарелка", "Пищевая упаковка пластик",
    "Пластиковая крышка", "Пакет майка", "Фасовочный пакет",
    "Стретч пленка", "Обертка от шоколадки", "Упаковка от молока",
    "Коробка от сока", "Бутылка от шампуня", "Бутылка от геля",
    "Тюбик от крема", "Пластиковый флакон", "Пластиковый блистер",

    // Металл
    "Алюминиевая банка", "Жестяная банка", "Металлическая крышка",
    "Консервная банка", "Фольга", "Алюминиевая форма для выпечки",
    "Банка от энергетика",

    // Стекло
    "Стеклянная бутылка", "Стеклянная банка", "Битое стекло",
    "Стеклянный стакан", "Флакон духов", "Стеклянная посуда",

    // Бумага
    "Картонная коробка", "Картонный стакан", "Бумажный пакет",
    "Газета", "Журнал", "Квитанция", "Бумажная упаковка",
    "Коробка от пиццы чистая", "Коробка от обуви",

    // Органика
    "Яблочный огрызок", "Банановая кожура", "Овощные отходы",
    "Яичная скорлупа", "Чайный пакетик", "Кофейная гуща",
    "Хлебные остатки", "Кожура цитрусовых",

    // Несортируемые
    "Грязная салфетка", "Памперс", "Ватные палочки",
    "Ватные диски", "Зубная щетка", "Одноразовая маска",
    "Резиновые перчатки", "Керамическая кружка", "Зеркало",

    // Опасные
    "Батарейка AA", "Батарейка AAA", "Аккумулятор",
    "Лампочка энергосберегающая", "Ртутный термометр",
    "Краска в банке", "Растворитель", "Просроченные лекарства",

    // Бытовая химия
    "Канистра моющего средства", "Флакон хлорки",
    "Флакон туалетного средства", "Коробка от порошка",
    "Тюбик зубной пасты",

    // Разное
    "Зубочистка", "Пластиковая щетка", "Коробка конфет",
    "Коробка от телефона", "Упаковка от игрушек",
    "Влажные салфетки упаковка", "Обертка от чипсов",
    "Обертка от снеков", "Картридж фильтра воды",

    // Электроника
    "USB кабель", "Наушники", "Пульт", "Флешка", "Компьютерная мышь"
];

function renderList(filter = "") {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    items
        .filter(item => item.toLowerCase().includes(filter.toLowerCase()))
        .forEach(name => {
            let div = document.createElement("div");
            div.className = "item";
            div.textContent = name;
            div.onclick = () => selectItem(name);
            grid.appendChild(div);
        });
}

document.getElementById("search").addEventListener("input", e => {
    renderList(e.target.value);
});

renderList();

// =======================
// ЛОГИКА АНАЛИЗА ЧЕРЕЗ GPT
// =======================
async function selectItem(name) {
    const apiKey = process.env.OPENAI_KEY;

    const prompt = `
Ты — эксперт по сортировке мусора. Определи утилизацию предмета по названию.
Верни только JSON в формате:

{
 "item": "...",
 "material": "...",
 "container": "...",
 "instructions": ["шаг 1", "шаг 2", "шаг 3"]
}
    `;

    try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                    {role: "system", content: prompt},
                    {role: "user", content: `Определи утилизацию предмета: "${name}"`}
                ]
            })
        });

        const data = await response.json();
        const raw = data?.choices?.[0]?.message?.content;

        if (!raw) {
            alert("Ошибка: пустой ответ нейросети");
            return;
        }

        localStorage.setItem("waste_json", raw);
        window.location.href = "result.html";

    } catch (err) {
        alert("Ошибка соединения: " + err.message);
        console.error(err);
    }
}
</script>

<script>
/**
 * Показывает видео, проигрывает его и возвращает Promise,
 * который resolve-ится, когда видео закончилось.
 */
function playLoadingVideo() {
    const video = document.getElementById("loadingVideo");
    if (!video) return Promise.resolve(); // на всякий случай

    return new Promise(resolve => {
        // сбрасываем состояние
        video.pause();
        video.currentTime = 0;
        video.style.display = "block";
        video.classList.remove("fade-out");
        void video.offsetWidth; // хак для перезапуска анимации
        video.classList.add("fade-in");

        // слушаем окончание видео
        const onEnded = () => {
            video.removeEventListener("ended", onEnded);

            video.classList.remove("fade-in");
            video.classList.add("fade-out");

            // чуть подождём, чтобы отыграла анимация исчезновения
            setTimeout(() => {
                video.style.display = "none";
                video.classList.remove("fade-out");
                resolve();
            }, 300);
        };

        video.addEventListener("ended", onEnded);

        // запускаем воспроизведение (на клик пользователя браузер разрешит)
        video.play().catch(err => {
            console.warn("Не удалось воспроизвести видео:", err);
            // если вдруг ошибка — просто сразу скрываем и resolve
            onEnded();
        });
    });
}

/**
 * Обёртка: одновременно запускает видео и асинхронную операцию.
 * Ждёт и конец видео, и завершение операции.
 *
 * usage:
 *   await withLoadingVideo(() => fetch(...));
 */
async function withLoadingVideo(asyncFn) {
    const videoPromise = playLoadingVideo();
    const fnPromise = asyncFn();

    // ждём и видео, и функцию
    await Promise.all([videoPromise, fnPromise]);

    // возвращаем результат функции (если нужно)
    return fnPromise;
}
</script>

<!-- ⬇ Глобальный видео-лоадер -->
<div id="loadingVideoOverlay">
    <video id="loadingVideo" src="loading.mp4" autoplay muted playsinline></video>
</div>

<style>
#loadingVideoOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: black;
    display: none;        /* скрыт по умолчанию */
    justify-content: center;
    align-items: center;
    z-index: 999999;
}

#loadingVideo {
    width: 100%;
    height: 100%;
    object-fit: cover; /* чтобы видео заполняло экран */
}
</style>

<!-- Полноэкранное видео-заглушка -->
<video id="loadingVideo"
       class="loading-video"
       src="loading.mp4"
       muted
       playsinline>
</video>


</body>
</html>
