<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–º–µ—Ä–∞</title>

    <style>
        body {
            background: #f7d85a;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
        }

        video {
            margin-top: 40px;
            width: 80%;
            max-width: 600px;
            border-radius: 20px;
            box-shadow: 0px 4px 12px rgba(0,0,0,0.3);
        }

        button {
            margin-top: 30px;
            padding: 18px 40px;
            font-size: 24px;
            border-radius: 40px;
            background: white;
            border: 2px solid black;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        .loading-video {
            position: fixed;
            inset: 0; /* top:0; right:0; bottom:0; left:0 */
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 9999;
            display: none;           /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ */
            background: black;
        }

        /* –º—è–≥–∫–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ / –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ, –ø–æ –∂–µ–ª–∞–Ω–∏—é */
        .loading-video.fade-in {
            animation: loadingFadeIn 0.4s ease forwards;
        }
        .loading-video.fade-out {
            animation: loadingFadeOut 0.4s ease forwards;
        }

        @keyframes loadingFadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        @keyframes loadingFadeOut {
            from { opacity: 1; }
            to   { opacity: 0; }
        }

    </style>
</head>
<body>

    <!-- –í–ê–ñ–ù–û: id="camera" -->
    <video id="camera" autoplay playsinline></video>

    <button onclick="takePhoto()">üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>

    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ—Ç canvas -->
    <canvas id="snapshot" style="display:none;"></canvas>

<script>
let video = document.getElementById("camera");
let canvas = document.getElementById("snapshot");
let imageBase64 = null;

// –∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => video.srcObject = stream)
    .catch(err => alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + err));

// –∫–Ω–æ–ø–∫–∞ —Å–Ω—è—Ç—å —Ñ–æ—Ç–æ
function takePhoto() {
    console.log("–î–µ–ª–∞–µ–º —Å–Ω–∏–º–æ–∫...");

    let w = video.videoWidth;
    let h = video.videoHeight;

    canvas.width = w;
    canvas.height = h;

    let ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);

    imageBase64 = canvas.toDataURL("image/png");
    console.log("–õ–∏–Ω–∏—è base64:", imageBase64.length);

    sendToServer();
}

// –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ /analyze
async function sendToServer() {
    if (!imageBase64) {
        alert("–û—à–∏–±–∫–∞: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ!");
        return;
    }

    console.log("–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä...");

    try {
        let response = await fetch("http://localhost:3000/analyze", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ image: imageBase64 })
        });

        console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", response.status);

        let data = await response.json();
        console.log("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª:", data);

        localStorage.setItem("waste_json", JSON.stringify(data));
        window.location.href = "result.html";

    } catch (err) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: " + err);
    }
}
</script>

<script>
/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ, –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç –µ–≥–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise,
 * –∫–æ—Ç–æ—Ä—ã–π resolve-–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –≤–∏–¥–µ–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å.
 */
function playLoadingVideo() {
    const video = document.getElementById("loadingVideo");
    if (!video) return Promise.resolve(); // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

    return new Promise(resolve => {
        // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        video.pause();
        video.currentTime = 0;
        video.style.display = "block";
        video.classList.remove("fade-out");
        void video.offsetWidth; // —Ö–∞–∫ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
        video.classList.add("fade-in");

        // —Å–ª—É—à–∞–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –≤–∏–¥–µ–æ
        const onEnded = () => {
            video.removeEventListener("ended", onEnded);

            video.classList.remove("fade-in");
            video.classList.add("fade-out");

            // —á—É—Ç—å –ø–æ–¥–æ–∂–¥—ë–º, —á—Ç–æ–±—ã –æ—Ç—ã–≥—Ä–∞–ª–∞ –∞–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
            setTimeout(() => {
                video.style.display = "none";
                video.classList.remove("fade-out");
                resolve();
            }, 300);
        };

        video.addEventListener("ended", onEnded);

        // –∑–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (–Ω–∞ –∫–ª–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—Ä–∞—É–∑–µ—Ä —Ä–∞–∑—Ä–µ—à–∏—Ç)
        video.play().catch(err => {
            console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≤–∏–¥–µ–æ:", err);
            // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –æ—à–∏–±–∫–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º –∏ resolve
            onEnded();
        });
    });
}

/**
 * –û–±—ë—Ä—Ç–∫–∞: –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–∏–¥–µ–æ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é.
 * –ñ–¥—ë—Ç –∏ –∫–æ–Ω–µ—Ü –≤–∏–¥–µ–æ, –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.
 *
 * usage:
 *   await withLoadingVideo(() => fetch(...));
 */
async function withLoadingVideo(asyncFn) {
    const videoPromise = playLoadingVideo();
    const fnPromise = asyncFn();

    // –∂–¥—ë–º –∏ –≤–∏–¥–µ–æ, –∏ —Ñ—É–Ω–∫—Ü–∏—é
    await Promise.all([videoPromise, fnPromise]);

    // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    return fnPromise;
}
</script>

<!-- ‚¨á –ì–ª–æ–±–∞–ª—å–Ω—ã–π –≤–∏–¥–µ–æ-–ª–æ–∞–¥–µ—Ä -->
<div id="loadingVideoOverlay">
    <video id="loadingVideo" src="loading.mp4" autoplay muted playsinline></video>
</div>

<style>
#loadingVideoOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: black;
    display: none;        /* —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    justify-content: center;
    align-items: center;
    z-index: 999999;
}

#loadingVideo {
    width: 100%;
    height: 100%;
    object-fit: cover; /* —á—Ç–æ–±—ã –≤–∏–¥–µ–æ –∑–∞–ø–æ–ª–Ω—è–ª–æ —ç–∫—Ä–∞–Ω */
}
</style>

<!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ-–∑–∞–≥–ª—É—à–∫–∞ -->
<video id="loadingVideo"
       class="loading-video"
       src="loading.mp4"
       muted
       playsinline>
</video>

</body>
</html>
