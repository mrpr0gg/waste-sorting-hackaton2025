<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>

    <style>
        body {
            font-family: "Inter", sans-serif;
            background: #f7d84b;
            margin: 0;
            padding: 30px 10px;
            display: flex;
            justify-content: center;
        }

        .profile-card {
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 25px;
            width: 95%;
            max-width: 650px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-block {
            background: rgba(255,255,255,0.45);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        ul {
            padding-left: 20px;
        }

        li {
            font-size: 20px;
            margin: 6px 0;
        }

        #leaderboard {
            background: rgba(255,255,255,0.55);
            padding: 22px;
            margin-top: 25px;
            border-radius: 20px;
        }

        .leader-item {
            background: rgba(255,255,255,0.8);
            padding: 12px 18px;
            border-radius: 14px;
            margin: 8px 0;
            font-size: 22px;
            animation: popIn 0.6s ease-out;
        }

        @keyframes popIn {
            0% { opacity:0; transform: scale(0.6); }
            60% { transform: scale(1.05); }
            100% { opacity:1; transform: scale(1); }
        }

        #error {
            color: red;
            font-size: 22px;
            font-weight: bold;
            margin-top: 20px;
            text-align: center;
        }
        /* –ö–Ω–æ–ø–∫–∞-–∫–∞—Ä–∞–Ω–¥–∞—à */
        .edit-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 26px;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform .25s ease;
        }

        .edit-btn:hover {
            transform: scale(1.15);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .profile-header {
            position: relative;
        }

        /* –û–≤–µ—Ä–ª–µ–π –º–∞–≥–∞–∑–∏–Ω–∞ */
        #shopOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.55);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* –û–∫–Ω–æ –º–∞–≥–∞–∑–∏–Ω–∞ */
        .shop-window {
            background: white;
            padding: 25px;
            width: 90%;
            max-width: 420px;
            border-radius: 20px;
            text-align: center;
            animation: pop .35s ease;
        }

        @keyframes pop {
            from { transform: scale(0.5); opacity: 0; }
            to   { transform: scale(1); opacity: 1; }
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .color-item {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #333;
            cursor: pointer;
            transition: transform .2s;
        }

        .color-item:hover {
            transform: scale(1.15);
        }

        .close-btn {
            margin-top: 20px;
            padding: 10px 25px;
            border-radius: 12px;
            background: #ffd34d;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .back-home-btn {
            padding: 18px 38px;
            font-size: 22px;
            font-weight: 600;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            background: #ffffffcc;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 14px rgba(0,0,0,0.18);
            transition: 0.25s ease;
        }

        .back-home-btn:hover {
            transform: scale(1.06);
            box-shadow: 0 6px 20px rgba(0,0,0,0.22);
        }

        .back-home-btn:active {
            transform: scale(0.96);
        }

    </style>
</head>

<body>

<div class="profile-card">
    <h1>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>

    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="error" style="display:none;"></div>

    <div id="content" style="display:none;">

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-block profile-header">
            <div>
                <p><b>–ò–º—è:</b> <span id="name"></span></p>
                <p><b>–í—Å–µ–≥–æ —Å–∫–∞–Ω–æ–≤:</b> <span id="scans"></span></p>
                <p><b>–û–¥–∂–µ—Ç—Ç–æ–Ω—ã:</b> <span id="tokens"></span></p>
            </div>

            <button class="edit-btn" onclick="openShop()">
                ‚úèÔ∏è
            </button>
        </div>


        <!-- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã -->
        <div class="stats-block">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º</h3>
            <ul id="materialsList"></ul>
        </div>

        <!-- –ß–∞—â–µ –≤—Å–µ–≥–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç -->
        <div class="stats-block">
            <h3>–ß–∞—â–µ –≤—Å–µ–≥–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç–µ</h3>
            <p id="topItem"></p>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è -->
        <div class="stats-block">
            <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∫–∞–Ω—ã</h3>
            <ul id="historyList"></ul>
        </div>

        <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ -->
        <div id="leaderboard">
            <h3 style="text-align:center;">üèÜ –õ–∏–¥–µ—Ä—ã –Ω–µ–¥–µ–ª–∏</h3>
            <div id="leaderboardList" style="margin-top:12px;"></div>
        </div>

    </div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// ---------------- FIREBASE ----------------
const firebaseConfig = {
    apiKey: "AIzaSyAzRjvFDkmmL509Z3ytx9Dibl4WE9cF3s0",
    authDomain: "mysorstat.firebaseapp.com",
    projectId: "mysorstat",
    storageBucket: "mysorstat.firebasestorage.app",
    messagingSenderId: "672693845408",
    appId: "1:672693845408:web:ecbb22b9b857aa2be2f8c5",
    measurementId: "G-Z9S58B91BP"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
window.currentUserId = null;
window.currentUserTokens = 0;


// ======================================================
//               –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
// ======================================================

window.addEventListener("DOMContentLoaded", async () => {

    const userId = new URLSearchParams(window.location.search).get("id");
    window.currentUserId = userId;

    if (!userId) {
        document.getElementById("error").innerText = "–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
        document.getElementById("loading").style.display = "none";
        return;
    }

    try {
        const ref = doc(db, "users", userId);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
            document.getElementById("error").innerText = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!";
            document.getElementById("loading").style.display = "none";
            return;
        }

        const data = snap.data();

        // ======================================================
        //               –û–°–ù–û–í–ù–´–ï –î–ê–ù–ù–´–ï –ü–†–û–§–ò–õ–Ø
        // ======================================================

        document.getElementById("name").textContent = data.name;
        document.getElementById("scans").textContent = data.scans ?? 0;

        const tokens = data.tokens ?? ((data.scans ?? 0) * 10);
        document.getElementById("tokens").textContent = tokens;
        window.currentUserTokens = tokens;

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è
        if (data.profileColor) {
            document.body.style.background = data.profileColor + "33";
        }


        // ---------------- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã ----------------
        const matList = document.getElementById("materialsList");
        matList.innerHTML = "";

        if (data.materials) {
            for (const [mat, count] of Object.entries(data.materials)) {
                const li = document.createElement("li");
                li.textContent = `${mat}: ${count}`;
                matList.appendChild(li);
            }
        } else {
            matList.innerHTML = "<li>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>";
        }

        // ---------------- –¢–æ–ø –ø—Ä–µ–¥–º–µ—Ç ----------------
        let best = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
        if (data.itemsCount) {
            let max = 0;
            for (const [item, num] of Object.entries(data.itemsCount)) {
                if (num > max) {
                    max = num;
                    best = `${item} (${num} —Ä–∞–∑)`;
                }
            }
        }
        document.getElementById("topItem").textContent = best;

        // ---------------- –ò—Å—Ç–æ—Ä–∏—è ----------------
        const history = document.getElementById("historyList");
        history.innerHTML = "";

        if (data.items && data.items.length > 0) {
            data.items.slice(-5).reverse().forEach(s => {
                const li = document.createElement("li");
                li.textContent = `${s.item} ‚Üí ${s.container}`;
                history.appendChild(li);
            });
        } else {
            history.innerHTML = "<li>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</li>";
        }


        // ======================================================
        //                    –õ–ò–î–ï–†–ë–û–†–î
        // ======================================================

        const allUsers = await getDocs(collection(db, "users"));
        let users = [];

        allUsers.forEach(u => {
            const d = u.data();
            const scans = d.scans ?? 0;
            const toks = d.tokens ?? scans * 10;

            users.push({
                name: d.name,
                scans,
                tokens: toks
            });
        });

        users.sort((a, b) => b.tokens - a.tokens);
        const top3 = users.slice(0, 3);

        const lbBox = document.getElementById("leaderboardList");
        lbBox.innerHTML = "";

        if (top3.length === 0) {
            lbBox.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>";
        } else {
            let place = 1;
            for (const u of top3) {
                const div = document.createElement("div");
                div.className = "leader-item";

                const medal =
                    place === 1 ? "ü•á" :
                    place === 2 ? "ü•à" : "ü•â";

                div.innerHTML = `${medal} <b>${u.name}</b> ‚Äî ${u.tokens} üí∞ <small>(${u.scans} —à—Ç.)</small>`;

                lbBox.appendChild(div);
                place++;
            }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        document.getElementById("loading").style.display = "none";
        document.getElementById("content").style.display = "block";

    } catch (err) {
        console.error(err);
        document.getElementById("error").innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö";
        document.getElementById("loading").style.display = "none";
    }
});



// ======================================================
//                –ú–ê–ì–ê–ó–ò–ù –£–ö–†–ê–®–ï–ù–ò–ô –ü–†–û–§–ò–õ–Ø
// ======================================================

// –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
window.openShop = function() {
    document.getElementById("shopOverlay").style.display = "flex";
};

// –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
window.closeShop = function() {
    document.getElementById("shopOverlay").style.display = "none";
};

// –ø–æ–∫—É–ø–∫–∞ —Ü–≤–µ—Ç–∞
window.buyColor = async function(color) {

    if (window.currentUserTokens < 20) {
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–∂–µ—Ç—Ç–æ–Ω–æ–≤!");
        return;
    }

    try {
        await updateDoc(doc(db, "users", window.currentUserId), {
            tokens: window.currentUserTokens - 20,
            profileColor: color
        });

        // –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        window.currentUserTokens -= 20;
        document.getElementById("tokens").textContent = window.currentUserTokens;

        // –ø—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç
        document.body.style.background = color + "33";

        alert("–¶–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!");
        closeShop();

    } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏ —Ü–≤–µ—Ç–∞");
    }
};

document.getElementById("backHomeBtn").addEventListener("click", () => {
    window.location.href = "index.html";
});

</script>

<!-- –ö–ù–û–ü–ö–ê "–ù–ê –ì–õ–ê–í–ù–£–Æ" -->
<div style="text-align:center; margin-top: 35px; margin-bottom: 45px;">
    <button id="backHomeBtn" class="back-home-btn">
        ‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é
    </button>
</div>


<div id="shopOverlay">
    <div class="shop-window">
        <h2>üé® –ú–∞–≥–∞–∑–∏–Ω —É–∫—Ä–∞—à–µ–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—è</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç (20 –æ–¥–∂–µ—Ç—Ç–æ–Ω–æ–≤)</p>

        <div class="color-grid">
            <div class="color-item" style="background:#ff7f7f" onclick="buyColor('#ff7f7f')"></div>
            <div class="color-item" style="background:#7fb3ff" onclick="buyColor('#7fb3ff')"></div>
            <div class="color-item" style="background:#7fff8a" onclick="buyColor('#7fff8a')"></div>
            <div class="color-item" style="background:#fff27f" onclick="buyColor('#fff27f')"></div>

            <div class="color-item" style="background:#d87fff" onclick="buyColor('#d87fff')"></div>
            <div class="color-item" style="background:#ffa77f" onclick="buyColor('#ffa77f')"></div>
            <div class="color-item" style="background:#7fffe4" onclick="buyColor('#7fffe4')"></div>
            <div class="color-item" style="background:#c6ff7f" onclick="buyColor('#c6ff7f')"></div>
        </div>

        <button class="close-btn" onclick="closeShop()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>


</body>
</html>
