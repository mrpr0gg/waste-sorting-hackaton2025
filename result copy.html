<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</title>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + addScanForCurrentUser) -->
    <script type="module" src="firebase.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f6d95c;
            font-family: "Inter", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin-top: 30px;
            font-size: 42px;
            font-weight: 800;
        }

        .card {
            margin-top: 30px;
            background: rgba(255,255,255,0.55);
            backdrop-filter: blur(18px);
            border-radius: 28px;
            padding: 35px;
            width: 85%;
            max-width: 650px;
            box-shadow: 0 6px 22px rgba(0,0,0,0.22);
        }

        .row {
            margin-bottom: 18px;
            font-size: 26px;
        }

        .label {
            font-weight: 700;
            font-size: 28px;
        }

        .container-box {
            background: rgba(255,255,255,0.8);
            padding: 18px;
            border-radius: 18px;
            font-size: 26px;
            text-align: center;
            margin: 25px 0;
            font-weight: 600;
        }

        ul {
            font-size: 22px;
            padding-left: 20px;
        }

        button {
            margin-top: 25px;
            width: 80%;
            max-width: 500px;
            padding: 18px;
            font-size: 26px;
            border-radius: 40px;
            border: 2px solid black;
            background: white;
            cursor: pointer;
            transition: 0.25s;
            font-weight: 600;
        }

        button:hover {
            transform: scale(1.05);
        }

        #next-btn {
            margin-top: 10px;
        }

        .error {
            font-size: 26px;
            color: red;
            font-weight: bold;
            text-align: center;
            margin-top: 40px;
        }
    </style>
</head>

<body>

<h1>–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h1>

<div id="errorBlock" class="error" style="display:none;"></div>

<div id="resultCard" class="card" style="display:none;">

    <div class="row">
        <span class="label">–ü—Ä–µ–¥–º–µ—Ç:</span>
        <span id="objectText"></span>
    </div>

    <div class="row">
        <span class="label">–ú–∞—Ç–µ—Ä–∏–∞–ª:</span>
        <span id="materialText"></span>
    </div>

    <div id="containerBox" class="container-box"></div>

    <div class="instructions">
        <span class="label">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ:</span>
        <ul id="instructionList"></ul>
    </div>
</div>

<button onclick="location.href='camera.html'">–°–¥–µ–ª–∞—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ</button>
<button id="next-btn">–î–∞–ª–µ–µ</button>


<script>
// ===============================
//   –£–ú–ù–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê
// ===============================
function normalizeContainer(raw) {
    if (!raw) return "‚ö´ –Ω–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –æ—Ç—Ö–æ–¥—ã";

    // —É–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏, –ø—Ä–æ–±–µ–ª—ã –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    let text = raw.replace(/[\p{Extended_Pictographic}]/gu, "").trim().toLowerCase();

    // –µ—Å–ª–∏ —É–∂–µ –ø—Ä–∏—à–ª–∞ –æ–¥–Ω–∞ –∏–∑ –Ω–∞—à–∏—Ö –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–æ–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—ë–º –µ—ë
    if (raw.includes("üü°") || text.includes("–∂—ë–ª—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä") || text.includes("–∂–µ–ª—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä")) {
        return "üü° –∂—ë–ª—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä";
    }
    if (raw.includes("üîµ") || text.includes("—Å–∏–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä")) {
        return "üîµ —Å–∏–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä";
    }
    if (raw.includes("üü¢") || text.includes("–∑–µ–ª—ë–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä") || text.includes("–∑–µ–ª–µ–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä")) {
        return "üü¢ –∑–µ–ª—ë–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä";
    }
    if (raw.includes("‚ö™") || text.includes("–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä")) {
        return "‚ö™ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä";
    }
    if (raw.includes("‚ö´") || text.includes("–Ω–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –æ—Ç—Ö–æ–¥—ã")) {
        return "‚ö´ –Ω–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –æ—Ç—Ö–æ–¥—ã";
    }

    // ------ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ —Ç–µ–∫—Å—Ç—É –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ ------

    // –ø–ª–∞—Å—Ç–∏–∫ / —É–ø–∞–∫–æ–≤–∫–∞ ‚Üí –∂—ë–ª—Ç—ã–π
    if (
        text.includes("–ø–ª–∞—Å—Ç") ||
        text.includes("pet") ||
        text.includes("—É–ø–∞–∫–æ–≤")
    ) {
        return "üü° –∂—ë–ª—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä";
    }

    // —Å—Ç–µ–∫–ª–æ ‚Üí —Å–∏–Ω–∏–π
    if (
        text.includes("—Å—Ç–µ–∫–ª") ||
        text.includes("glass")
    ) {
        return "üîµ —Å–∏–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä";
    }

    // –±—É–º–∞–≥–∞ / –∫–∞—Ä—Ç–æ–Ω ‚Üí –∑–µ–ª—ë–Ω—ã–π
    if (
        text.includes("–±—É–º–∞–≥") ||
        text.includes("–±—É–º–∞–∂") ||
        text.includes("–∫–∞—Ä—Ç–æ–Ω") ||
        text.includes("paper")
    ) {
        return "üü¢ –∑–µ–ª—ë–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä";
    }

    // –º–µ—Ç–∞–ª–ª / –∂–µ—Å—Ç—è–Ω–∫–∞ / –∞–ª—é–º–∏–Ω–∏–π ‚Üí –±–µ–ª—ã–π
    if (
        text.includes("–º–µ—Ç–∞–ª–ª") ||
        text.includes("–∞–ª—é–º–∏") ||
        text.includes("–∂–µ—Å—Ç—è–Ω")
    ) {
        return "‚ö™ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä";
    }

    // –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –Ω–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ
    return "‚ö´ –Ω–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –æ—Ç—Ö–æ–¥—ã";
}

// ===============================
//    –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
// ===============================
let parsed = null;

try {
    parsed = JSON.parse(localStorage.getItem("waste_json"));
} catch (e) {
    parsed = null;
}

if (!parsed) {
    const err = document.getElementById("errorBlock");
    err.textContent = "–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã.";
    err.style.display = "block";
} else {
    document.getElementById("resultCard").style.display = "block";

    document.getElementById("objectText").textContent   = parsed.item     || "-";
    document.getElementById("materialText").textContent = parsed.material || "-";

    // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–Ω—É –∞–∫–∫—É—Ä–∞—Ç–Ω—É—é —Å—Ç—Ä–æ–∫—É
    const normalizedContainer = normalizeContainer(parsed.container || "");
    document.getElementById("containerBox").textContent = normalizedContainer;

    const list = document.getElementById("instructionList");
    list.innerHTML = "";
    (parsed.instructions || []).forEach(x => {
        const li = document.createElement("li");
        li.textContent = x;
        list.appendChild(li);
    });
}

// ===============================
//     –ö–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ"
// ===============================
const nextBtn = document.getElementById("next-btn");

nextBtn.addEventListener("click", async () => {
    if (!parsed) {
        alert("–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞.");
        return;
    }

    const scanData = {
        item:      parsed.item      ?? "",
        material:  parsed.material  ?? "",
        container: parsed.container ?? ""
    };

    console.log("‚û° –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–∫–∞–Ω –≤ Firebase:", scanData);

    // –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤: –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –ø–æ–¥–≥—Ä—É–∑–∏–ª–∞—Å—å ‚Äî –Ω–µ –ª–æ–º–∞–µ–º –∫–Ω–æ–ø–∫—É
    if (typeof window.addScanForCurrentUser === "function") {
        try {
            await window.addScanForCurrentUser(scanData);
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ addScanForCurrentUser:", e);
        }
    } else {
        console.warn("addScanForCurrentUser –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ window. –ü—Ä–æ–≤–µ—Ä—å –∑–∞–≥—Ä—É–∑–∫—É firebase.js");
    }

    const username = localStorage.getItem("username");
    if (!username) {
        alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (localStorage.username)");
        return;
    }

    const id   = username.toLowerCase().trim();
    const link = `https://mysorstat.web.app/profile.html?id=${encodeURIComponent(id)}`;
    localStorage.setItem("profile_link", link);

    window.location.href = "qr.html";
});
</script>

<!-- ‚¨á –ì–ª–æ–±–∞–ª—å–Ω—ã–π –≤–∏–¥–µ–æ-–ª–æ–∞–¥–µ—Ä -->
<div id="loadingVideoOverlay">
    <video id="loadingVideo" src="loading.mp4" autoplay muted playsinline></video>
</div>

<style>
#loadingVideoOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: black;
    display: none;        /* —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    justify-content: center;
    align-items: center;
    z-index: 999999;
}

#loadingVideo {
    width: 100%;
    height: 100%;
    object-fit: cover; /* —á—Ç–æ–±—ã –≤–∏–¥–µ–æ –∑–∞–ø–æ–ª–Ω—è–ª–æ —ç–∫—Ä–∞–Ω */
}
</style>

<script>
window.showLoadingVideo = function () {
    const overlay = document.getElementById("loadingVideoOverlay");
    const video = document.getElementById("loadingVideo");
    overlay.style.display = "flex";
    video.currentTime = 0;   // –∑–∞–ø—É—Å–∫ —Å –Ω–∞—á–∞–ª–∞
    video.play();
};

window.hideLoadingVideo = function () {
    document.getElementById("loadingVideoOverlay").style.display = "none";
};
</script>

</body>
</html>
